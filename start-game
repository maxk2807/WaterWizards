#!/bin/bash

# WaterWizards Universal Game Launcher
# Works on macOS, Linux, and Windows (with Git Bash/WSL)

echo "ğŸš€ WaterWizards - Game Launcher"
echo "================================"

# Detect OS for better messaging
if [[ "$OSTYPE" == "msys" || "$OSTYPE" == "cygwin" ]]; then
    OS="Windows"
elif [[ "$OSTYPE" == "darwin"* ]]; then
    OS="macOS"
else
    OS="Linux"
fi

echo "ğŸŒ Detected OS: $OS"
echo ""

# Build the solution first to avoid simultaneous builds
echo "ğŸ“¦ Building solution..."
dotnet build WaterWizards.sln

if [ $? -ne 0 ]; then
    echo "âŒ Build failed! Please fix the errors and try again."
    read -p "Press Enter to exit..."
    exit 1
fi

echo "âœ… Build successful!"

# Function to cleanup background processes on exit
cleanup() {
    echo ""
    echo "ğŸ›‘ Shutting down WaterWizards..."
    
    # Kill all dotnet processes related to our projects
    pkill -f "WaterWizard.Server" 2>/dev/null
    pkill -f "WaterWizard.Client" 2>/dev/null
    
    echo "âœ… All processes stopped."
    exit 0
}

# Set up signal handlers for cleanup
trap cleanup SIGINT SIGTERM

echo ""
echo "ğŸ® Starting WaterWizards components..."
echo ""

# Start the server in background
echo "ğŸ–¥ï¸  Starting server..."
dotnet run --project src/WaterWizard.Server/WaterWizard.Server.csproj > server.log 2>&1 &
SERVER_PID=$!

# Wait a moment for server to start
sleep 2

# Check if server started successfully
if ! kill -0 $SERVER_PID 2>/dev/null; then
    echo "âŒ Server failed to start. Check server.log for details."
    exit 1
fi

# Start first client
echo "ğŸ‘¤ Starting client 1..."
dotnet run --project src/WaterWizard.Client/WaterWizard.Client.csproj > client1.log 2>&1 &
CLIENT1_PID=$!

# Wait a moment for first client to start
sleep 1

# Start second client
echo "ğŸ‘¤ Starting client 2..."
dotnet run --project src/WaterWizard.Client/WaterWizard.Client.csproj > client2.log 2>&1 &
CLIENT2_PID=$!

echo ""
echo "âœ… All components started successfully!"
echo "ğŸ“‹ Process IDs:"
echo "   Server: $SERVER_PID (logs: server.log)"
echo "   Client 1: $CLIENT1_PID (logs: client1.log)"
echo "   Client 2: $CLIENT2_PID (logs: client2.log)"
echo ""
echo "ğŸ¯ Game is ready! Press Ctrl+C to stop all components."
echo "ğŸ“ Logs are saved to server.log, client1.log, and client2.log"
echo ""

# Wait for user to press Ctrl+C
wait 